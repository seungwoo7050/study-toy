name: CI Build

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK
        id: setup-java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'

      - name: Cache Gradle wrapper distribution
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ runner.os }}-${{ hashFiles('**/gradle/wrapper/gradle-wrapper.properties') }}
          restore-keys: |
            gradle-${{ runner.os }}-

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Android SDK components
        run: |
          yes | sdkmanager \
            "platform-tools" \
            "platforms;android-34" \
            "build-tools;34.0.0"

      - name: Build backend (Spring)
        working-directory: backend/mini-job-service
        run: |
          chmod +x ./gradlew
          ./gradlew clean build

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: npm
          cache-dependency-path: |
            backend/mini-job-service-node/package-lock.json
            frontend/mini-job-dashboard/package-lock.json

      - name: Build backend (Node.js)
        working-directory: backend/mini-job-service-node
        run: |
          npm ci
          npm run build
          npm test

      - name: Build frontend
        working-directory: frontend/mini-job-dashboard
        env:
          VITE_API_BASE_URL: http://localhost:8080/api
        run: |
          npm ci
          npm run lint --if-present
          npm run test:unit --if-present
          npm run build

      - name: Frontend smoke test (serve dist)
        run: |
          echo "Running frontend dist smoke test"
          ./scripts/frontend-smoke-test.sh

      - name: "Frontend: Install Playwright browsers"
        working-directory: frontend/mini-job-dashboard
        run: |
          npm ci
          npx playwright install --with-deps

      - name: "Frontend: Run Playwright E2E tests"
        working-directory: frontend/mini-job-dashboard
        run: |
          npm ci
          npm run test:e2e

      - name: Build C++ projects
        working-directory: cpp
        run: |
          cd battle-game && g++ -std=c++17 -O2 -Wall main.cpp Character.cpp Player.cpp Monster.cpp -o battle-game || true
          cd ../echo-server && ./build.sh || true
          cd ../multi-chat-server && g++ -std=c++17 -O2 -Wall chat-server.cpp -o chat-server || true

      - name: Run backend tests
        working-directory: backend/mini-job-service
        run: ./gradlew test --no-daemon

      - name: Build Android Compose sample
        working-directory: android/hello-kotlin-todo
        run: |
          chmod +x ./gradlew
          ./gradlew --no-daemon --stacktrace lint test assembleDebug
